<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <!-- ★★★ iPad最適化①：誤操作による拡大・縮小を禁止 ★★★ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>期末試験・最終チェック</title>

  <!-- ★★★ iPad最適化②：SafariのUIを消すための呪文 ★★★ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="最終チェック">

  <style>
    /* --- 超・最小限CSS【iPad最適化版】 --- */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", "メイリオ", Meiryo, sans-serif;
      background-color: #E6F2F7;
      margin: 0;
      padding: 1rem;
      color: #333;
      -webkit-user-select: none;
      user-select: none;
      font-size: 1.125rem;
    }
    .container {
      max-width: 768px;
      margin: 0 auto;
    }
    .screen { display: none; }
    .button {
      display: block;
      width: 90%;
      max-width: 500px;
      margin: 1.5rem auto;
      padding: 1.75rem;
      border-radius: 16px;
      background-color: #4CAF50;
      color: white;
      text-align: center;
      font-size: 1.75rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .button { border: none; -webkit-appearance: none; appearance: none; -webkit-tap-highlight-color: transparent; }

    /* ===== HOME画面 科目グリッドレイアウト ===== */
    .subject-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      max-width: 600px;
      margin: 2rem auto;
    }
    .subject-button {
      padding: 2rem 1rem;
      border-radius: 16px;
      background-color: #4CAF50;
      color: white;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border: none;
      -webkit-appearance: none;
      appearance: none;
      -webkit-tap-highlight-color: transparent;
    }
    .subject-button:active { opacity: 0.85; }
    .question-box {
      background-color: white;
      padding: 2rem;
      margin: 1.5rem 0;
      border-radius: 16px;
      font-size: 1.5rem;
      line-height: 1.7;
    }
    .option-button {
      display: block;
      width: 100%;
      margin-top: 1.25rem;
      padding: 1.25rem;
      border: 2px solid #ddd;
      border-radius: 16px;
      background-color: white;
      font-size: 1.25rem;
      cursor: pointer;
      text-align: left;
    }
    .correct { background-color: #C8E6C9; border-color: #4CAF50; font-weight: bold; }
    .incorrect { background-color: #FFCDD2; border-color: #F44336; }
    .explanation {
      background-color: #FFF9C4;
      padding: 1.25rem;
      margin-top: 1.5rem;
      border-radius: 12px;
      border-left: 6px solid #FFEB3B;
      font-size: 1.1rem;
    }
    .self-eval-container {
        display: flex;
        justify-content: space-around;
        margin-top: 1.5rem;
    }
    .self-eval-button {
      display: inline-block;
      width: 48%;
      padding: 1.25rem;
      border-radius: 12px;
      text-align: center;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.25rem;
    }
    .perfect-btn { background-color: #2196F3; color: white; }
    .review-btn { background-color: #FF9800; color: white; }

    /* --- 画面内ナビ（戻る） --- */
    .topbar { display: flex; justify-content: flex-end; align-items: center; gap: .5rem; }
    .nav-btn { border: none; -webkit-appearance: none; appearance: none; -webkit-tap-highlight-color: transparent; cursor: pointer; padding: .6rem .9rem; border-radius: 10px; background: #1f2937; color: #fff; font-size: 1rem; }
    .nav-btn:active { opacity: .8; }
  </style>
</head>
<body>

  <div class="container">

    <!-- ===== HOME画面 ===== -->
    <div id="home-screen" class="screen" style="display:block;">
      <h1 style="text-align: center; font-size: 2.5rem;">期末試験・最終チェック</h1>
      <div id="mode-select" style="max-width:500px;margin:0.5rem auto 1rem auto;padding:.6rem 1rem;background:#fff;border-radius:12px;border:1px solid #e5e7eb;font-size:1rem;">
        <div style="display:flex;align-items:center;gap:.75rem;flex-wrap:wrap;">
          <strong>出題モード:</strong>
          <label style="display:flex;align-items:center;gap:.35rem;">
            <input type="radio" name="mode" value="all" checked>
            <span>全問</span>
          </label>
          <label style="display:flex;align-items:center;gap:.35rem;">
            <input type="radio" name="mode" value="review">
            <span>復習（あやしいのみ）</span>
          </label>
        </div>
      </div>
      <div class="subject-grid">
        <button class="subject-button" type="button" data-subject="english">英語</button>
        <button class="subject-button" type="button" data-subject="kokugo">国語</button>
        <button class="subject-button" type="button" data-subject="rika">理科</button>
        <button class="subject-button" type="button" data-subject="shakai">社会</button>
        <button class="subject-button" type="button" data-subject="kateika">家庭・技科</button>
        <button class="subject-button" type="button" data-subject="bijutsu">美術</button>
        <button class="subject-button" type="button" data-subject="taiiku">体育</button>
      </div>
    </div>

    <!-- ===== 問題画面 ===== -->
    <div id="quiz-screen" class="screen">
      <div class="topbar">
        <button id="back-home-btn" class="nav-btn" type="button">🏠 ホームへ</button>
      </div>
      <h2 id="quiz-title" style="text-align: center; font-size: 2rem;"></h2>
      <div id="progress-text" style="text-align: center; color: #555; font-size: 1.2rem;"></div>
      <div id="question-box" class="question-box">
        <div id="question-text"></div>
        <div id="options-container"></div>
        <div id="explanation-box" class="explanation" style="display:none;"></div>
      </div>
      <div id="self-eval-container" class="self-eval-container"></div>
      <div id="retry-container" class="self-eval-container" style="margin-top: .5rem;"></div>
    </div>

  </div>

  <script>
    // ===== HOMEボタンのクリック/タッチを確実に拾うバインド =====
    function bindHomeButtons() {
      const home = document.getElementById('home-screen');
      if (!home) return;
      const handler = (subj) => (e) => { e.preventDefault(); startQuiz(subj); };
      home.querySelectorAll('.subject-button[data-subject]').forEach(btn => {
        const subj = btn.dataset.subject;
        // 多重登録を避けるため一度だけ
        if (!btn.__bound) {
          btn.addEventListener('click', handler(subj), { passive: false });
          btn.addEventListener('touchend', handler(subj), { passive: false });
          btn.__bound = true;
        }
      });
    }

    // ===== 1. 問題データ本体（教科ごとに分割し、安全装置を追加） =====

    // --- 英語の問題データ ---
    const Q_ENGLISH = [
      { "id": "eng_s01", "type": "choice", "question": "「ずっと〜の状態です」という意味を表す、現在完了形（継続）の基本的な形はどれ？", "options": { "a": "主語 + have + 動詞の-ing形", "b": "主語 + have + been ~", "c": "主語 + be動詞 + 過去分詞" }, "answer": "b", "explanation": "【虎の巻】現在完了形（継続）: 主語 + have / has + been ~" },
      { "id": "eng_s02", "type": "choice", "question": "次の文の( )に、for か since のどちらかが入るよ。\n\nI have been a volunteer ( ) 2000.", "options": { "a": "for", "b": "since" }, "answer": "b", "explanation": "【虎の巻】since + 時点 (2000年という過去の時点) がルールだよ。" },
      { "id": "eng_s03", "type": "choice", "question": "「レストランを経営しているおじさん」という意味になるのはどれかな？", "options": { "a": "an uncle which runs a restaurant", "b": "an uncle who runs a restaurant", "c": "an uncle runs a restaurant" }, "answer": "b", "explanation": "【虎の巻】関係代名詞（人）: 名詞（人）+ who + 動詞。人が相手だから who を使うよ。" },
      { "id": "eng_s04_who_variation1", "type": "choice", "question": "「数学が得意な人」という意味になるのはどれ？ (エイゴラボ Room46より)", "options": { "a": "a person who good at math", "b": "a person who is good at math", "c": "a person is good at math" }, "answer": "b", "explanation": "【虎の巻】関係代名詞（人）: who の後ろには、be動詞(is)もちゃんと必要だよ！" },
      { "id": "eng_s05_who_variation2", "type": "choice", "question": "「決してあきらめない人々」という意味になるのはどれ？ (エイゴラボ Room46より)", "options": { "a": "people who never gives up", "b": "people who never give up", "c": "people never give up" }, "answer": "b", "explanation": "【虎の巻】関係代名詞（人）: 先行詞(people)が複数形だから、動詞(give)に s は付かないのがルール！" },
      { "id": "eng_s06_which_variation1", "type": "choice", "question": "「幸せな結末の映画」という意味になるのはどれ？ (エイゴラボ Room47より)", "options": { "a": "a movie which has a happy ending", "b": "a movie which have a happy ending", "c": "a movie has a happy ending" }, "answer": "a", "explanation": "【虎の巻】関係代名詞（モノ）: 先行詞(a movie)が単数形だから、動詞は has になるよ！" },
      { "id": "eng_a01", "type": "choice", "question": "「私にこれの使い方を見せて」と、やり方を見せてほしい時に使うのはどっち？", "options": { "a": "tell me how to use this", "b": "show me how to use this", "c": "ask me how to use this" }, "answer": "b", "explanation": "【虎の巻】間接疑問文: show は「見せる」、tell は「言う」。やり方だから show がピッタリ！" },
      { "id": "eng_a02", "type": "choice", "question": "「爆弾が落とされた」と、〜された、という意味を表す受動態の文はどれ？", "options": { "a": "The bomb dropped.", "b": "The bomb was dropped.", "c": "The bomb is dropped." }, "answer": "b", "explanation": "【虎の巻】受動態（過去形）: 主語 + was / were + 過去分詞。過去の話だから was を使うよ。" },
      { "id": "eng_a03", "type": "choice", "question": "「その知らせは私を悲しくさせた」と、AをBの状態に「させた」という意味になるのは？", "options": { "a": "The news was sad for me.", "b": "I was sad by the news.", "c": "The news made me sad." }, "answer": "c", "explanation": "【虎の巻】使役動詞 make: make + 人/モノ + 形容詞 の形だよ。" },
      { "id": "eng_a04_what_to_variation1", "type": "choice", "question": "「何を飲むべきか決められない」という意味になるのはどれ？ (エイゴラボ Room35より)", "options": { "a": "I can't decide what drink.", "b": "I can't decide what to drink.", "c": "I can't decide to what drink." }, "answer": "b", "explanation": "【虎の巻】間接疑問文: what to + 動詞の原形 の形が基本だよ。" },
      { "id": "eng_sort01", "type": "sort", "question": "日本語に合うように、下のボタンを並べ替えてみよう！\n\n「私には、広島に住んでいるおじがいます」", "options": ["lives", "an", "who", "in", "I", "uncle", "have", "Hiroshima."], "answer": ["I", "have", "an", "uncle", "who", "lives", "in", "Hiroshima."], "explanation": "【虎の巻】関係代名詞（人）: I have an uncle + He lives in Hiroshima. を who で繋げるよ！" },
      { "id": "eng_sort02_extra", "type": "sort_extra", "question": "日本語に合うように並べ替えよう！ただし、不要な語が1つあるよ。\n\n「これは広島へ行くそのバスです」", "options": ["the", "is", "a", "goes", "that", "bus", "this", "to", "Hiroshima."], "answer": ["This", "is", "the", "bus", "that", "goes", "to", "Hiroshima."], "extraWord": "a", "explanation": "「そのバス」と特定しているので the を使う。a は不要だよ。" },
      { "id": "eng_vocab_s01", "type": "choice", "question": "「平和」を意味する英単語はどれ？", "options": { "a": "peace", "b": "piece", "c": "pork" }, "answer": "a", "explanation": "【S級単語】peace = 平和。pieceは「かけら」だから間違えないように！" },
      { "id": "eng_vocab_s02", "type": "choice", "question": "「ボランティア」を意味する英単語はどれ？", "options": { "a": "borantia", "b": "volunteer", "c": "barrier" }, "answer": "b", "explanation": "【S級単語】volunteer = ボランティア。スペルも書けるようにしておこう！" },
      { "id": "eng_vocab_s03", "type": "choice", "question": "「装置」や「機器」を意味する英単語はどれ？", "options": { "a": "drive", "b": "divide", "c": "device" }, "answer": "c", "explanation": "【S級単語】device = 装置。AI device (AI装置) のように使われるよ。" },
      { "id": "eng_vocab_s04", "type": "choice", "question": "「〜を翻訳する」という意味の動詞はどれ？", "options": { "a": "transport", "b": "translate", "c": "transfer" }, "answer": "b", "explanation": "【S級単語】translate = 〜を翻訳する。translation software (翻訳ソフト)で覚えよう。" },
      { "id": "eng_vocab_a01", "type": "choice", "question": "「政府」を意味する英単語はどれ？", "options": { "a": "government", "b": "goverment", "c": "govermentt" }, "answer": "a", "explanation": "【A級単語】government = 政府。n を忘れないように、スペルが超重要！" },
      { "id": "eng_vocab_a02", "type": "choice", "question": "「難民」を意味する英単語はどれ？", "options": { "a": "refuge", "b": "refuse", "c": "refugee" }, "answer": "c", "explanation": "【A級単語】refugee = 難民。杉原千畝の物語で出てきたね。" },
      { "id": "eng_vocab_a03", "type": "choice", "question": "「便利な」という意味の形容詞はどれ？", "options": { "a": "convinient", "b": "konbini", "c": "convenient" }, "answer": "c", "explanation": "【A級単語】convenient = 便利な。これもスペルが難しいから要注意！" },
      { "id": "eng_vocab_a04", "type": "choice", "question": "熟語「pass ( )」で、「〜を伝える」という意味になるのは？", "options": { "a": "in", "b": "on", "c": "out" }, "answer": "b", "explanation": "【A級熟語】pass on = 〜を伝える。pass out は「気絶する」だから全然違う意味だよ。" },
      { "id": "eng_vocab_a05", "type": "choice", "question": "熟語「take ( )」で、「行動を起こす」という意味になるのは？", "options": { "a": "action", "b": "act", "c": "actor" }, "answer": "a", "explanation": "【A級熟語】take action = 行動を起こす。これはセットで覚えよう！" }
    ];

    // --- 国語の問題データ ---
    const Q_KOKUGO = [

  {"id": "koku_s01", "type": "choice", "question": "「会社の将来をモサクする。」\nこのカタカナを漢字で正しく書いたものはどれ？", "options": {"a": "模索", "b": "摸索", "c": "模柵"}, "answer": "a", "explanation": "「手本」や「模様」の「模」と、「探す」という意味の「索」を使います。「摸索」の「摸」は「手探り」という意味で間違いやすいので注意！"},
  {"id": "koku_s02", "type": "choice", "question": "「チョウサの対象となる。」\nこのカタカナを漢字で正しく書いたものはどれ？", "options": {"a": "調査", "b": "調車", "c": "朝査"}, "answer": "a", "explanation": "「調べる」という意味の「調」と、「検査」の「査」を組み合わせた言葉です。"},
  {"id": "koku_s03", "type": "choice", "question": "「責任をテンカする。」\nこのカタカナを漢字で正しく書いたものはどれ？", "options": {"a": "転化", "b": "点火", "c": "転嫁"}, "answer": "c", "explanation": "「嫁（よめ）」という字には「自分の過ちを人のせいにする」という意味もあります。「責任をお嫁に出す」とイメージすると覚えやすいです。"},
  {"id": "koku_s04", "type": "choice", "question": "「このパンは、まだ食べられる。」\n下線部の助動詞「られる」の意味はどれ？", "options": {"a": "受け身", "b": "可能", "c": "尊敬", "d": "自発"}, "answer": "b", "explanation": "「食べることができる」という意味なので「可能」です。「～できる」と置き換えられれば可能！"},
  {"id": "koku_s05", "type": "choice", "question": "「先生もその映画をご覧になられたそうだ。」\n下線部の助動動詞「られ」の意味はどれ？", "options": {"a": "受け身", "b": "可能", "c": "尊敬", "d": "自発"}, "answer": "c", "explanation": "「ご覧になる」という尊敬語についている「られる」は「尊敬」の意味になります。先生など、目上の人の行動に使われます。"},
  {"id": "koku_s06", "type": "choice", "question": "優美で理知的な歌が多く、紀貫之らが撰者である平安時代の和歌集はどれ？", "options": {"a": "万葉集", "b": "古今和歌集", "c": "新古今和歌集"}, "answer": "b", "explanation": "平安時代のキーワードは「たをやめぶり（優美・理知的）」。代表的な撰者が紀貫之である「古今和歌集」が正解です。"},
  {"id": "koku_a01", "type": "choice", "question": "「春過ぎて 夏来たるらし 白たへの 衣干したり 天の香具山」\nこの歌の作者は誰？", "options": {"a": "柿本人麻呂", "b": "額田王", "c": "持統天皇"}, "answer": "c", "explanation": "万葉集に収められている有名な歌で、作者は持統天皇です。季節の移り変わりを詠んでいます。"},
  {"id": "koku_s07", "type": "choice", "question": "詩『挨拶』で、「焼けただれた顔」と対比的に描かれているのは、どのような顔？", "options": {"a": "すがすがしい朝の顔", "b": "すこやかな今日の顔", "c": "戦火の跡もとどめぬ"}, "answer": "b", "explanation": "この詩は「原爆による過去の悲劇」と「現在の平和な日常」を対比しています。「すこやかな今日の顔」が現在の平和を象徴しています。"},
  {"id": "koku_a02", "type": "choice", "question": "『アラスカとの出会い』で、筆者がアラスカへ行く直接のきっかけとなったものは何？", "options": {"a": "友人からの手紙", "b": "テレビ番組", "c": "一冊の写真集"}, "answer": "c", "explanation": "筆者は神田の古本屋で偶然見つけた一冊の写真集の中にある、シシュマレフ村の写真に強く心を惹かれ、アラスカへ行くことを決意しました。"},
  {"id": "koku_a03", "type": "choice", "question": "『奄美・沖縄』で述べられている、世界自然遺産が抱える対立した二つのテーマとは何？", "options": {"a": "伝統文化 と 外来文化", "b": "経済効果 と 自然保護", "c": "島の生活 と 都市の生活"}, "answer": "b", "explanation": "この記事では、観光客が増えることによる「経済効果」と、それによって貴重な自然が破壊される危険性という「自然保護」の問題をどう両立させるかがテーマです。"},
  {"id": "koku_s08", "type": "choice", "question": "助動詞「う・よう」には推量・意志・勧誘の意味があります。\n「さあ、みんなで考えよう。」の「よう」の意味はどれ？", "options": {"a": "推量（～だろう）", "b": "意志（～するつもりだ）", "c": "勧誘（～しませんか）"}, "answer": "c", "explanation": "「みんなで～しよう」と相手を誘っているので「勧誘」です。「私がやろう」なら意志、「明日は晴れるだろう」なら推量になります。"},
  {"id": "koku_s09", "type": "choice", "question": "奈良時代に成立し、「ますらをぶり」と評される力強い歌風が特徴の和歌集はどれ？", "options": {"a": "万葉集", "b": "古今和歌集", "c": "新古今和歌集"}, "answer": "a", "explanation": "「ますらをぶり（男性的で力強い）」は『万葉集』のキーワードです。天皇から農民まで、様々な身分の人の歌が収められています。"},
  {"id": "koku_a04", "type": "choice", "question": "詩『挨拶』で、筆者が「りつぜんとする」のはなぜ？ 最も適切なものを選びなさい。", "options": {"a": "目の前の人の美しさに感動したから。", "b": "悲惨な原爆写真のことを思い出して悲しくなったから。", "c": "平和な日常の中に、核戦争でそれが失われるかもしれない危険を感じたから。"}, "answer": "c", "explanation": "「りつぜんとする」は「恐ろしさで身震いする」という意味です。平和な顔の「明日」を想像した時に、その平和が核によって脅かされているという恐ろしい現実に気づいたのです。"},
  {"id": "koku_a05", "type": "choice", "question": "『アラスカとの出会い』で、筆者は人生をどのようなものだと考えている？", "options": {"a": "自分の強い意志で切り開いていくもの", "b": "たくさんの偶然の出会いが重なってできあがっていくもの", "c": "あらかじめ運命によって全てが決められているもの"}, "answer": "b", "explanation": "筆者は「かぎりなく無数の偶然が続いてゆくだけ」と述べています。古本屋での一冊の写真集との出会いのように、偶然が人生を大きく動かすと考えているのです。"},
  {"id": "koku_b01", "type": "choice", "question": "助動詞「た」には過去・完了・存続などの意味があります。\n「壁にかかっていた絵」の「いた」の意味はどれ？", "options": {"a": "過去", "b": "完了", "c": "存続"}, "answer": "c", "explanation": "「～ていた」「～てある」の形で、「～という状態が続いている」ことを表す場合、「存続」の意味になります。動作が終わったことを示す「完了」との区別がポイントです。"},
  {"id": "koku_s10", "type": "choice", "question": "『古今和歌集 仮名序』で、和歌の力の大きさを説明するために挙げられていないものはどれ？", "options": {"a": "天地を動かす", "b": "鬼神をあはれと思わせる", "c": "死者をよみがえらせる"}, "answer": "c", "explanation": "『仮名序』では、和歌の力を「力をも入れずして天地を動かし、目に見えぬ鬼神をもあはれと思わせ…」と表現していますが、「死者をよみがえらせる」とまでは言っていません。"},
  {"id": "koku_a06", "type": "choice", "question": "『奄美・沖縄』で問題になっている「オーバーツーリズム」とは、どのような意味？", "options": {"a": "観光客が減りすぎて、経済が成り立たなくなること", "b": "観光客が増えすぎて、自然環境や住民の生活に悪影響が出ること", "c": "海外からの観光客のマナーが悪いこと"}, "answer": "b", "explanation": "「オーバーツーリズム」は「観光公害」とも訳されます。観光客がキャパシティを超えて押し寄せることで起こる様々な問題のことです。"},
  {"id": "koku_s11", "type": "choice", "question": "詩『挨拶』の最終連です。\n言葉を正しく並べ替えると、どのようになりますか？", "options": {"a": "やすらかに 美しく 油断していた", "b": "やすらかに 油断していた 美しく", "c": "美しく やすらかに 油断していた"}, "answer": "a", "explanation": "最終連「やすらかに 美しく 油断していた」は、原爆で亡くなった人々と、今を生きる私たちへのメッセージが込められた、この詩の重要な締めくくりです。"},
  {"id": "koku_b02", "type": "choice", "question": "鎌倉時代に成立し、「幽玄」や「有心」といった、余韻を重視する歌風が特徴の和歌集はどれ？", "options": {"a": "万葉集", "b": "古今和歌集", "c": "新古今和歌集"}, "answer": "c", "explanation": "「幽玄（奥深く、かすかな趣）」や「有心（内容が深く、優雅な美しさ）」は、『新古今和歌集』の重要なキーワードです。藤原定家らが撰者です。"},
  {"id": "koku_a07", "type": "choice", "question": "「ユウシュウな成績をおさめる。」\nこのカタカナを漢字で正しく書いたものはどれ？", "options": {"a": "有終", "b": "優秀", "c": "憂愁"}, "answer": "b", "explanation": "成績が「すぐれている」という意味なので「優秀」です。「有終」は「有終の美を飾る」のように最後までやり遂げること、「憂愁」は「うれい」という意味です。"},
  {"id": "koku_s12", "type": "choice", "question": "助動詞「ない」は、動詞のどの活用形に接続しますか？", "options": {"a": "未然形", "b": "連用形", "c": "終止形"}, "answer": "a", "explanation": "「書か（未然形）ない」「起き（未然形）ない」のように、打ち消しの助動詞「ない」は未然形に接続します。これは文法の基本ルールです。"},
  {"id": "koku_a08", "type": "choice", "question": "『古今和歌集 仮名序』の冒頭の一節です。\n言葉を正しく並べ替えると、どのようになりますか？", "options": {"a": "やまとうたは 人の心を 種として", "b": "人の心を やまとうたは 種として", "c": "やまとうたは 種として 人の心を"}, "answer": "a", "explanation": "「やまとうたは、人の心を種として、よろづの言の葉とぞなれりける。」という有名な一節です。和歌が人の心から生まれることを、植物が種から芽吹くことに例えています。"},
  {"id": "koku_s13", "type": "choice", "question": "「ソチを講じる。」\nこのカタカナを漢字で正しく書いたものはどれ？", "options": {"a": "処置", "b": "措置", "c": "素地"}, "answer": "b", "explanation": "「措置」は、ある事態に対応するための処置をとることです。「処置」は手当てや処理をすること。文脈によって使い分けが必要です。"},
  {"id": "koku_b03", "type": "choice", "question": "「私は」「その本を」「です」「読みたい」という言葉を使い、「私はその本を読みたい」という文を作るとき、不要な言葉はどれ？", "options": {"a": "私は", "b": "です", "c": "読みたい"}, "answer": "b", "explanation": "希望を表す助動詞「たい」は、それ自体で文を終えることができます。「～です」を付けると丁寧になりますが、文を完成させるために必須ではありません。"},
  {"id": "koku_a09", "type": "choice", "question": "詩『挨拶』の最終連「油断していた」という言葉は、誰に向けられたものですか？", "options": {"a": "原爆を投下したアメリカ", "b": "当時の日本の指導者", "c": "原爆で亡くなった人々と、現代を生きる私たち"}, "answer": "c", "explanation": "「あの時、人々は油断していた。そして、平和な今を生きるあなた（私たち）も油断しているのではないか？」という、過去と現在をつなぐ鋭い問いかけです。"}

    ];

    // --- 社会の問題データ ---
    const Q_SHAKAI = [
      { id: "sha_01", type: "choice", question: "自由民権運動の中心人物は？", options: { a: "板垣退助", b: "伊藤博文" }, answer: "a", explanation: "土佐藩出身の人物です。" }
    ];

    // --- 理科の問題データ ---
    const Q_RIKA = [
      { id: "rika_01", type: "choice", question: "減数分裂で、染色体の数はどうなる？", options: { a: "2倍になる", b: "半分になる", c: "変わらない" }, answer: "b", explanation: "生殖細胞ができるときの分裂です。" }
    ];

    // --- 副教科の問題データ（後で追加可。空でも動作させるためのプレースホルダ） ---
    const Q_KATEIKA = [];
    const Q_BIJUTSU  = [];
    const Q_TAIIKU   = [
      {"id": "hoken_s01", "type": "choice", "question": "細菌やウイルスなどの【病原体】が体の中に侵入して、定着・増殖することを何といいますか？", "options": {"a": "感染症", "b": "感染", "c": "発病"}, "answer": "b", "explanation": "病原体が体に入ることを「感染」といいます。「感染症」は、感染によって病気が起こることを指します。"},
      {"id": "hoken_s02", "type": "choice", "question": "感染症が成立するための3つの条件を正しい順序で並べたものはどれですか？", "options": {"a": "感染経路 → 感染源 → 体の抵抗力", "b": "感染源 → 感染経路 → 体の抵抗力", "c": "体の抵抗力 → 感染源 → 感染経路"}, "answer": "b", "explanation": "感染症は、①病原体を持つ「感染源」があり、②それがうつるための「感染経路」を通って、③「体の抵抗力」が弱った人に感染することで成立します。"},
      {"id": "hoken_s03", "type": "choice", "question": "新型コロナウイルス感染症のように、新しく発見された感染症を特に何といいますか？", "options": {"a": "再興感染症", "b": "新興感染症", "c": "流行感染症"}, "answer": "b", "explanation": "新しく発見された感染症を「新興感染症」といいます。ちなみに、結核のように一度は制圧されたかに見えて再び流行するものを「再興感染症」といいます。"},
      {"id": "hoken_s04", "type": "choice", "question": "性感染症の一つである【性器クラミジア感染症】の大きな特徴として正しいものはどれですか？", "options": {"a": "男性は症状が出ないことが多い", "b": "一度かかると再発することはない", "c": "女性は症状が出ないことが多い"}, "answer": "c", "explanation": "性器クラミジア感染症は、特に女性で症状が出にくく、気づかないうちに進行して不妊の原因になることがあるため注意が必要です。"},
      {"id": "hoken_s05", "type": "choice", "question": "性感染症を治療しないで放置した場合に起こりうる、最も深刻な問題の一つは何ですか？", "options": {"a": "不眠の原因になる", "b": "不妊の原因になる", "c": "視力が低下する"}, "answer": "b", "explanation": "性感染症を放置すると、男女ともに不妊の原因になることがあります。また、母親から胎児に感染する「母子感染」のリスクもあります。"},
      {"id": "hoken_s06", "type": "choice", "question": "エイズの原因となるウイルスの正式名称として正しいものはどれですか？", "options": {"a": "ヒト不全免疫ウイルス", "b": "免疫不全ヒトウイルス", "c": "ヒト免疫不全ウイルス"}, "answer": "c", "explanation": "エイズの原因となるウイルスは「ヒト免疫不全ウイルス」で、アルファベット3文字で「HIV」と略されます。"},
      {"id": "hoken_s07", "type": "choice", "question": "HIVの感染を予防するために、性的接触において有効な方法は何ですか？", "options": {"a": "低用量ピルを服用する", "b": "コンドームを正しく使用する", "c": "性交後にシャワーを浴びる"}, "answer": "b", "explanation": "HIVの感染予防には、コンドームを正しく使用することが有効です。性的接触をしないことが最も確実な予防法です。"},
      {"id": "hoken_s08", "type": "choice", "question": "人々が自らの健康をより良くコントロールし、改善できるようにしていく社会全体の取り組みを何といいますか？", "options": {"a": "セルフメディケーション", "b": "ヘルスプロモーション", "c": "ユニバーサルデザイン"}, "answer": "b", "explanation": "個人の努力だけでなく、社会全体で健康を支援する考え方や取り組みを「ヘルスプロモーション」といいます。"},
      {"id": "hoken_s09", "type": "choice", "question": "【保健所】と【保健センター】の違いについて、正しい説明はどれですか？", "options": {"a": "保健所は市町村が運営し、身近な健康相談などを行う。", "b": "保健所は都道府県などが運営し、専門的・広域的な対策を行う。", "c": "保健センターは都道府県が運営し、食中毒対策などを行う。"}, "answer": "b", "explanation": "保健所は都道府県などが運営する専門的な機関、保健センターは市町村が運営する住民に身近な機関です。"},
      {"id": "hoken_s10", "type": "choice", "question": "日常的な病気の診療や健康管理について相談できる身近な医師のことを特に何といいますか？", "options": {"a": "専門医", "b": "かかりつけ医", "c": "担当医"}, "answer": "b", "explanation": "普段から自分の体質や病歴を理解してくれている身近な医師を「かかりつけ医」といい、健康を維持するために重要な存在です。"},
      {"id": "hoken_a01", "type": "choice", "question": "医薬品を使ったときに現れる、病気を治すといった本来の目的となる作用を何といいますか？", "options": {"a": "副作用", "b": "主作用", "c": "効果"}, "answer": "b", "explanation": "薬に期待される本来の目的の作用を「主作用」といいます。それ以外の好ましくない作用を「副作用」といいます。"},
      {"id": "hoken_s11", "type": "choice", "question": "医師の診断・処方に基づいて出される薬のことを何といいますか？", "options": {"a": "医療用医薬品", "b": "一般用医薬品", "c": "医薬用医療品"}, "answer": "a", "explanation": "医師から処方される薬は「医療用医薬品」です。処方薬とも呼ばれます。"},
      {"id": "hoken_s12", "type": "choice", "question": "薬局などで自分の判断で購入できる薬のことを何といいますか？", "options": {"a": "医療用医薬品", "b": "一般用医薬品", "c": "専用医薬品"}, "answer": "b", "explanation": "薬局などで直接購入できる薬は「一般用医薬品」です。大衆薬や市販薬、OTC医薬品とも呼ばれます。"},
      {"id": "hoken_a02", "type": "choice", "question": "自分自身の健康に責任を持ち、軽いけがや病気の際に【一般用医薬品】などを使って自分で手当てすることを何といいますか？", "options": {"a": "ヘルスプロモーション", "b": "セルフケア", "c": "セルフメディケーション"}, "answer": "c", "explanation": "自分自身で健康を管理し、軽い症状のときに一般用医薬品で対処することを「セルフメディケーション」といいます。"}
        ];

    // --- 安全装置（ChatGPT提案）---
    function deepFreeze(o){ Object.freeze(o); Object.getOwnPropertyNames(o).forEach(k=>{ const v=o[k]; if(typeof v==="object"&&v!==null&&!Object.isFrozen(v)) deepFreeze(v); }); return o;}
    function ensureUniqueIds(groups){ const seen=new Set(); for(const [subj, arr] of Object.entries(groups)){ for(const q of arr){ if(seen.has(q.id)) { console.error(`ID重複: ${q.id} (${subj})`); } seen.add(q.id); } } }

    // --- データを統合 ---
    const ALL_QUESTIONS = {
      english: Q_ENGLISH,
      kokugo:  Q_KOKUGO,
      shakai:  Q_SHAKAI,
      rika:    Q_RIKA,
      kateika: Q_KATEIKA,
      bijutsu: Q_BIJUTSU,
      taiiku:  Q_TAIIKU,
    };
    ensureUniqueIds(ALL_QUESTIONS);
    deepFreeze(ALL_QUESTIONS);

    // ===== 2. アプリの主要な変数 =====
    const STATUS = { PERFECT: 'perfect', REVIEW: 'review' };
    const SUBJECT_NAMES = {
      english: '英語',
      kokugo:  '国語',
      shakai:  '社会',
      rika:    '理科',
      kateika: '家庭・技科',
      bijutsu: '美術',
      taiiku:  '体育'
    };
    let currentSubject = '';
    let currentQuestions = [];
    let currentIndex = 0;
    let progress = {};
    let statsSubjectKey = ''; // 現在科目の進捗保存キー（ローカルストレージ用）

    // ===== 3. 主要なDOM要素 =====
    const homeScreen = document.getElementById('home-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const quizTitle = document.getElementById('quiz-title');
    const progressText = document.getElementById('progress-text');
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const explanationBox = document.getElementById('explanation-box');
    const selfEvalContainer = document.getElementById('self-eval-container');
    const retryContainer = document.getElementById('retry-container');
    const backHomeBtn = document.getElementById('back-home-btn');
    const modeSelect = document.getElementById('mode-select');

    // ★★★ 安全なテキスト表示関数 ★★★
    function setQuestionText(el, text) {
      const esc = String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      el.innerHTML = esc.replace(/\n/g, "<br>");
    }

    // ===== 4. クイズのロジック =====
    function getSelectedMode(){
      const sel = modeSelect ? modeSelect.querySelector('input[name="mode"]:checked') : null;
      return sel ? sel.value : 'all';
    }

    function startQuiz(subject) {
      currentSubject = subject;
      const startMode = getSelectedMode();
      statsSubjectKey = 'progress_' + currentSubject;
      loadProgress();
      
      if (!progress || typeof progress !== 'object') progress = {};
      if (!progress.statuses || typeof progress.statuses !== 'object') progress.statuses = {};
      if (!progress.stats || typeof progress.stats !== 'object') progress.stats = {};

      const allQs = ALL_QUESTIONS[subject] || [];
      const reviewQuestions = allQs.filter(q => q.type === 'choice' && progress.statuses[q.id] === STATUS.REVIEW);

      if (startMode === 'review') {
        progress.isReviewMode = true;
        currentQuestions = reviewQuestions.length > 0 ? reviewQuestions : [];
      } else {
        progress.isReviewMode = false;
        currentQuestions = allQs;
      }

      // 非対応タイプ（並べ替えなど）は現行UIでは未対応のため除外
      currentQuestions = currentQuestions.filter(q => q.type === 'choice');

      // 空の復習リストだった場合のフォールバック（全問に自動切替）
      if (progress.isReviewMode && currentQuestions.length === 0) {
        progress.isReviewMode = false;
        currentQuestions = allQs.filter(q => q.type === 'choice');
      }

      if (currentIndex < 0 || currentIndex >= currentQuestions.length) {
        currentIndex = 0;
      }
      
      showScreen('quiz');
      displayQuestion();
    }

    function displayQuestion() {
      if (currentIndex >= currentQuestions.length) {
        handleQuizEnd();
        return;
      }

      const q = currentQuestions[currentIndex];
      quizTitle.textContent = SUBJECT_NAMES[currentSubject] || currentSubject;
      progressText.textContent = `${currentIndex + 1} / ${currentQuestions.length} 問`;
      
      setQuestionText(questionText, q.question);
      
      optionsContainer.innerHTML = '';
      explanationBox.style.display = 'none';
      selfEvalContainer.innerHTML = '';
      retryContainer.innerHTML = '';

      const keys = Object.keys(q.options).sort();
      for (const key of keys) {
        const button = document.createElement('button');
        button.className = 'option-button';
        button.dataset.key = key;
        button.textContent = `${key}. ${q.options[key]}`;
        button.onclick = () => checkAnswer(key, q.answer);
        optionsContainer.appendChild(button);
      }
    }

    function checkAnswer(selectedKey, correctKey) {
      const buttons = optionsContainer.getElementsByTagName('button');
      for (let i = 0; i < buttons.length; i++) buttons[i].disabled = true;

      for (let i = 0; i < buttons.length; i++) {
        const key = buttons[i].dataset.key;
        if (key === correctKey) {
          buttons[i].classList.add('correct');
        } else if (key === selectedKey) {
          buttons[i].classList.add('incorrect');
        }
      }

      const q = currentQuestions[currentIndex];
      // === 問題ごとの正解/不正解カウントを更新 ===
      if (!progress.stats) progress.stats = {};
      const stat = (progress.stats[q.id] = progress.stats[q.id] || { correct: 0, incorrect: 0 });
      const wasCorrect = (selectedKey === correctKey);
      if (wasCorrect) stat.correct++; else stat.incorrect++;
      flushProgress();
      const statNow = progress.stats && progress.stats[q.id] ? progress.stats[q.id] : { correct: 0, incorrect: 0 };
      const correctLabel = (q.options && q.options[correctKey]) ? `${correctKey}. ${q.options[correctKey]}` : String(correctKey);
      const selectedLabel = (q.options && q.options[selectedKey]) ? `${selectedKey}. ${q.options[selectedKey]}` : String(selectedKey);
      const nowPart = wasCorrect ? '[今回] 正解' : '[今回] 不正解';
      const yourPart = (!wasCorrect && q.options && q.options[selectedKey]) ? `\n[あなたの回答] ${selectedLabel}` : '';
      explanationBox.textContent = `${q.explanation}\n${nowPart}\n[正解] ${correctLabel}${yourPart}\n[この問題の累計] 正解: ${statNow.correct} / 不正解: ${statNow.incorrect}`;
      explanationBox.style.display = 'block';
      createSelfEvalButtons(); // 再回答でもボタンを再度用意
    }
    
    function createSelfEvalButtons() {
        selfEvalContainer.innerHTML = `
            <div class="self-eval-button perfect-btn" onclick="handleSelfEvaluation(STATUS.PERFECT)">完璧！✨</div>
            <div class="self-eval-button review-btn" onclick="handleSelfEvaluation(STATUS.REVIEW)">あやしい…💦</div>
        `;
        // すぐに増分が見えるよう、同じ問題を再挑戦できるボタンを用意
        retryContainer.innerHTML = `
            <button id="retry-btn" class="nav-btn" type="button">↻ もう一度この問題を解く</button>
        `;
        const rb = document.getElementById('retry-btn');
        if (rb && !rb.__bound) {
          rb.addEventListener('click', (e) => {
            e.preventDefault();
            retryCurrentQuestion();
          }, { passive: false });
          rb.__bound = true;
        }
    }

    function retryCurrentQuestion() {
      // 同じ問題を出し直す（インデックスは進めない）
      const q = currentQuestions[currentIndex];
      if (!q) return;
      // 再描画
      setQuestionText(questionText, q.question);
      optionsContainer.innerHTML = '';
      explanationBox.style.display = 'none';
      selfEvalContainer.innerHTML = '';
      retryContainer.innerHTML = '';
      const keys = Object.keys(q.options).sort();
      for (const key of keys) {
        const button = document.createElement('button');
        button.className = 'option-button';
        button.dataset.key = key;
        button.textContent = `${key}. ${q.options[key]}`;
        button.onclick = () => checkAnswer(key, q.answer);
        optionsContainer.appendChild(button);
      }
    }

    function handleSelfEvaluation(status) {
      const q = currentQuestions[currentIndex];
      progress.statuses[q.id] = status;
      currentIndex++;
      flushProgress();
      displayQuestion();
    }

    function handleQuizEnd() {
      const remainCount = (ALL_QUESTIONS[currentSubject] || []).filter(q => q.type === 'choice' && progress.statuses[q.id] === STATUS.REVIEW).length;
      if (remainCount > 0) {
        if (confirm(`お疲れ様！\nまだ「あやしい」問題が ${remainCount} 問あります。続けて復習しますか？`)) {
          progress.isReviewMode = true;
          currentIndex = 0;
          flushProgress();
          startQuiz(currentSubject);
          return;
        }
      }
      alert('全問終了！お疲れ様でした！');
      showScreen('home');
    }

    // ===== 最小ヘルパー（未定義なら用意） =====
    if (typeof showScreen !== 'function') {
      function showScreen(screenName) {
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        const el = document.getElementById(`${screenName}-screen`);
        if (el) el.style.display = 'block';
      }
    }
    if (typeof loadProgress !== 'function') {
      function loadProgress() {
        // 科目ごとの保存キーで復元（存在しない場合は初期化）
        const key = 'progress_' + currentSubject;
        try {
          const saved = localStorage.getItem(key);
          if (saved) {
            const s = JSON.parse(saved);
            progress = {
              statuses: (s && s.statuses) || {},
              isReviewMode: !!(s && s.isReviewMode),
              stats: (s && s.stats) || {}
            };
            currentIndex = Number.isInteger(s && s.currentIndex) ? s.currentIndex : 0;
          } else {
            progress = { statuses: {}, isReviewMode: false, stats: {} };
            currentIndex = 0;
          }
        } catch (e) {
          console.warn('進捗の読み込みに失敗しました:', e);
          progress = { statuses: {}, isReviewMode: false, stats: {} };
          currentIndex = 0;
        }
      }
    }
    if (typeof flushProgress !== 'function') {
      function flushProgress() {
        const key = 'progress_' + currentSubject;
        try {
          const state = {
            statuses: progress.statuses || {},
            isReviewMode: !!progress.isReviewMode,
            currentIndex: currentIndex,
            stats: progress.stats || {}
          };
          localStorage.setItem(key, JSON.stringify(state));
        } catch (e) {
          console.warn('進捗の保存に失敗しました:', e);
        }
      }
    }

    // ===== 初期表示（DOM読み込み後にHOMEを必ず表示） =====
    document.addEventListener('DOMContentLoaded', () => {
      showScreen('home');
      bindHomeButtons();
      if (backHomeBtn && !backHomeBtn.__bound) {
        backHomeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          flushProgress();
          showScreen('home');
        }, { passive: false });
        backHomeBtn.__bound = true;
      }
    });

  </script>
</body>
</html>