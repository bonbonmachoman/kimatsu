# クイズロジックの詳細説明

このドキュメントでは、クイズアプリケーションの主要なロジックについて説明します。

## 1. 出題モード

ユーザーはHOME画面で3つの出題モードから選択できます。

### 全問モード
- **対象:** 選択した科目のすべての問題（選択式のみ）が出題されます。
- **再開機能:**
  - 前回の学習記録 (`currentIndex`) が残っている場合、クイズ開始時に「前回の続き(X問目)から再開しますか？」という確認ダイアログが表示されます。
  - 「OK」を選択すると、前回の続きからクイズが始まります。
  - 「キャンセル」を選択するか、記録がない場合は、常に1問目から始まります。

### 復習モード
- **対象:** ユーザーが回答後に「あやしい…💦」と自己評価した問題のみが出題されます。
  - `progress.statuses` オブジェクトに `review` ステータスで記録されている問題が該当します。
- **特徴:**
  - 復習対象の問題が存在しない場合は、「『あやしい』にチェックされた問題はありません。」というアラートが表示され、クイズは開始されません。
  - 常に1問目から始まります。

### 復習＋未着手（続き）
- **対象:** 「復習モード」の対象問題と、まだ一度も回答したことがない「未着手」の問題を合わせたリストが出題されます。
  - **復習問題:** 「あやしい…💦」と評価された問題。
  - **未着手問題:** 解答履歴 (`progress.stats` オブジェクト) に記録が全くない問題。
- **特徴:**
  - 出題リストは復習問題と未着手問題を合わせたセットとなり、必ずしも復習問題が先、未着手問題が後という順序は保証されません（重複はありません）。
  - 対象の問題が存在しない場合は、「復習・未着手の問題はありません。」というアラートが表示されます。
  - 常に1問目から始まります。

## 2. `currentIndex` の扱い

`currentIndex` は、現在表示されている問題リスト (`currentQuestions`) におけるユーザーの位置を示すインデックス番号です。

- **初期化:**
  - **全問モード:** 前述の再開機能により、`0` または保存された値で初期化されます。
  - **その他モード:** 常に `0` で初期化されます。
- **更新:** ユーザーが問題を解き、自己評価ボタン（「完璧！✨」または「あやしい…💦」）を押すと、`currentIndex` が `+1` され、次の問題へ進みます。
- **保存:** `currentIndex` の値は、進捗が保存されるタイミングで `localStorage` に書き込まれます。

## 3. 進捗の保存 (`progress`)

学習の進捗は、`flushProgress()` 関数によって `localStorage` に保存されます。データは科目ごとに管理されます（例: `progress_english`）。

### 保存されるデータ
- `statuses`: 各問題の自己評価（`perfect` または `review`）。
- `stats`: 各問題の生涯正解数・不正解数。
- `currentIndex`: 現在の問題リストにおけるインデックス。

### 保存のタイミング
進捗が失われないよう、以下の主要なタイミングで自動的に保存されます。

1.  **クイズ開始時:** `startQuiz()` 関数内。
    - `currentIndex` が `0` または再開位置に設定された直後に保存されます。
2.  **回答時:** `checkAnswer()` 関数内。
    - 正解・不正解のカウント (`stats`) が更新された直後に即座に保存されます。`currentIndex` の保存は後述の自己評価時に行われます。
3.  **次の問題へ進む時:** `handleSelfEvaluation()` 関数内。
    - `currentIndex` がインクリメントされた直後に保存されます。
4.  **HOME画面へ戻る時:** 「🏠 ホームへ」ボタンが押された時に保存されます。
5.  **全問終了時:** `handleQuizEnd()` 関数内。
    - クイズが完全に終了し、`currentIndex` が `0` にリセットされた後に保存されます。
